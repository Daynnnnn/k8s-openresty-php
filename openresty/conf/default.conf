server {
	listen 80 default_server;

	root /src-shared/public;

	add_header Pod $hostname;

	modsecurity on;
	modsecurity_rules_file /etc/nginx/modsec/rules/conf/tortix_waf.conf;
	modsecurity_rules_file /etc/nginx/modsec/rules/00_aaa_whitelist.conf;
	modsecurity_rules_file /etc/nginx/modsec/rules/00_asl_whitelist.conf;
	modsecurity_rules_file /etc/nginx/modsec/rules/00_asl_x_searchengines.conf;
	modsecurity_rules_file /etc/nginx/modsec/rules/00_asl_y_searchengines.conf;
	modsecurity_rules_file /etc/nginx/modsec/rules/00_asl_z_antievasion.conf;
	modsecurity_rules_file /etc/nginx/modsec/rules/00_asl_zz_strict.conf;
	modsecurity_rules_file /etc/nginx/modsec/rules/01_asl_content.conf;
	modsecurity_rules_file /etc/nginx/modsec/rules/03_asl_dos.conf;
	modsecurity_rules_file /etc/nginx/modsec/rules/05_asl_exclude.conf;
	modsecurity_rules_file /etc/nginx/modsec/rules/10_asl_rules.conf;
	modsecurity_rules_file /etc/nginx/modsec/rules/11_asl_data_loss.conf;
	modsecurity_rules_file /etc/nginx/modsec/rules/12_asl_brute.conf;
	modsecurity_rules_file /etc/nginx/modsec/rules/20_asl_useragents.conf;
	modsecurity_rules_file /etc/nginx/modsec/rules/30_asl_antispam.conf;
	modsecurity_rules_file /etc/nginx/modsec/rules/31_asl_urispam.conf;
	modsecurity_rules_file /etc/nginx/modsec/rules/50_asl_rootkits.conf;
	modsecurity_rules_file /etc/nginx/modsec/rules/51_asl_rootkits.conf;
	modsecurity_rules_file /etc/nginx/modsec/rules/60_asl_recons.conf;
	modsecurity_rules_file /etc/nginx/modsec/rules/61_asl_recons_dlp.conf;
	modsecurity_rules_file /etc/nginx/modsec/rules/98_asl_jitp.conf;
	modsecurity_rules_file /etc/nginx/modsec/rules/99_asl_jitp.conf;

	index index.php index.html index.htm;

	server_name _;

	location / {
		try_files $uri $uri/ /index.php?$query_string;
	}

	# PHP files to PHP
	location ~ \.php$ {
		try_files $uri =404;
		include fastcgi_params;
		fastcgi_split_path_info ^(.+\.php)(/.+)$;
		fastcgi_pass 127.0.0.1:9000;
		fastcgi_param SERVER_NAME $http_host;
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		fastcgi_param SCRIPT_NAME $fastcgi_script_name;
		fastcgi_index index.php;
		fastcgi_read_timeout 30s;
		fastcgi_request_buffering off;
		fastcgi_param PHP_VALUE "atatus.enabled=on;";
	}

	# Nginx Health Check Endpoint
	location ~ ^/(healthz)$ {
	    content_by_lua_block {
	    	ngx.status = 200
	    	ngx.header['Content-Type'] = 'text/plain'
        	ngx.say("Nginx OK")
        	ngx.exit(ngx.OK)
    	}
    	access_log off;
	}

	error_page 403 /403.html;
	error_page 404 /404.html;
	error_page 500 /500.html;
	error_page 502 /502.html;
	error_page 504 /504.html;

	location = /403.html {
    	root /usr/local/openresty/nginx/html;
    	internal;
    }
    location = /404.html {
    	root /usr/local/openresty/nginx/html;
    	internal;
    }
    location = /500.html {
    	root /usr/local/openresty/nginx/html;
    	internal;
    }
    location = /502.html {
    	root /usr/local/openresty/nginx/html;
    	internal;
    }
    location = /504.html {
    	root /usr/local/openresty/nginx/html;
    	internal;
    }

}